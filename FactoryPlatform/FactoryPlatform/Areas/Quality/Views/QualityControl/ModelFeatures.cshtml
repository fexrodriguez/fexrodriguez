@using System.IO
@using FactoryPlatform.Library
@using Microsoft.AspNetCore.Hosting
@using Microsoft.Extensions.Configuration

@model ModelFeaturesViewModel
@*Es para generar el token seguro para toda la pagina y no utilizar los forms*@
@Html.AntiForgeryToken()
@{
    ViewData["Title"] = ViewData["Titulo"];
}
<div class="post d-flex flex-column-fluid" id="kt_post">
    <div id="kt_content_container" class="container-fluid">
        <div id="kt_block_ModelFeacture">
            <div class="card mb-7">

                <div class="card-body p-5" id="kt_block_ModelFeatures">
                    <form id="frmBusqueda" asp-area="Quality" asp-controller="QualityControl" asp-action="ModelFeatures" method="post">
                        <div class="row">
                            <input type="hidden" name="Station" id="Station" value="@Model.Station" />
                            <input type="hidden" name="SeccionId" id="IdSeccion" value="@Model.IdSeccion" />
                            <input type="hidden" name="serieFinal" id="serieFinal" value="@Model.Serie" />
                            <input type="hidden" name="modeloFinal" id="modeloFinal" value="@Model.Modelo" />
                            <input type="hidden" name="Tipo" id="Tipo" value="@Model.Tipo" />
                            <div class="col-lg-2 fv-row mb-4">
                                <label class="fs-6 form-label fw-bolder text-dark">Serie</label>
                                <input name="Serie" id="Serie" value="@Model.Serie" type="text" class="form-control   ps-3 p-3 fs-8" placeholder="Serie" autofocus />
                            </div>
                            <div class="col-lg-2 fv-row">
                                <label class="fs-6 form-label fw-bolder text-dark">Model</label>
                                <input name="Modelo" id="Modelo" value="@Model.Modelo" type="text" class="form-control ps-3 p-3 fs-8" placeholder="Model" autocomplete="off" autofocus />
                            </div>
                            <div class="col-lg-3 fv-row mb-4 pt-8 me-0">
                                <button type="button" id="Search" class="btn btn-primary p-3 fs-8 me-3" onclick="ValidarModelo()"><i class="fas fa-search"></i>Search</button>
                                @if (Model.Serie != null && Model.Modelo != null && Model.QualityModelFeatures != null)
                                {
                                    if (Model.QualityModelFeatures.Count > 0)
                                    {
                                        <button type="button" id="btnAccept" class="btn btn-success p-3 fs-8 me-3" onclick="Execute(1)">&nbsp;<i class="fas fa-check"></i>Accept</button>
                                        <button type="button" id="btnReject" class="btn btn-danger p-3 fs-8" onclick="Execute(0)">&nbsp;<i class="fa fa-times"></i>Reject</button>
                                    }
                                }
                            </div>
                            @if (Model.QualityModelFeatures.Count > 0)
                            {
                                <div class="col-lg-3 mb-4 pt-8">
                                    <input id="divTitulo" type="button" class="btn p-3 fw-bold fs-4 text-dark" disabled />
                                </div>
                            }
                        </div>
                    </form>

                    <div class="border border-gray-100 p-0 mb-0"></div>

                    <div class="card-body ">
                        @if (Model.QualityModelFeatures.Count > 0)
                        {
                            <div class="tab-content d-flex flex-column-fluid flex-center" id="tabs">
                                @{
                                    int intContadorCaracteristicas = 1;
                                    foreach (var item in Model.QualityModelFeatures)
                                    {
                                        string CaruselActivo = intContadorCaracteristicas != 1 ? "" : "active  ";
                                        var divIdCarrucel = $"IdCarrucel{intContadorCaracteristicas}";
                                        var divIdCarac = $"divID{intContadorCaracteristicas}";
                                        var divTituCarac = $"divTitulo{intContadorCaracteristicas}";

                                                                <div class="tab-pane fade show @CaruselActivo" id="tab_@intContadorCaracteristicas" role="tabpanel">
                                                                    <div id="@divIdCarrucel" class="carousel slide w-lg-1000px " data-bs-touch="false" data-bs-interval="false">
                                                                        <div class="carousel-inner">
                                                                            @{
                                                        var intContadorImg = 1;
                                                        if (Model.FilesModelFeactures.Count > 0)
                                                        {
                                                            var fileNames = Model.FilesModelFeactures.Where(f => f.RegistroId == item.IdRegistro).ToList();
                                                                                                            @foreach (var file in fileNames)
                                                            {
                                                                var src = $"https://mxesc1vapp001/photocenter/Planta{item.PlantaId}/model-features/{item.Modelo}/{item.IdRegistro}/large/{file.FileName}";
                                                                string stractive = intContadorImg != 1 ? "" : "active";
                                                                                                                <div class="carousel-item @stractive">
                                                                                                                    <div class="d-flex flex-column-fluid flex-center">
                                                                                                                        <img src="@src" class="d-block w-100 w-lg-1000px h-lg-700px" alt="...">
                                                                                                                    </div>
                                                                                                                    <div class="d-flex flex-column-auto h-50px bg-dark flex-center text-center">
                                                                                                                        <span class="text-white">@item.Descripcion.ToUpper()</span>
                                                                                                                    </div>
                                                                                                                </div>
                                                                intContadorImg++;
                                                            }
                                                        }
                                                        else
                                                        {
                                                                                                            <p class="text-danger">There's a issue with the Images, please contact the Administration System.</p>
                                                        }
                                                                            }
                                                                        </div>
                                                                        <button class="carousel-control-prev" type="button" data-bs-target="#@divIdCarrucel" data-bs-slide="prev">
                                                                            <i class="fas fa-caret-square-left fs-5x"></i>
                                                                        </button>
                                                                        <button class="carousel-control-next" type="button" data-bs-target="#@divIdCarrucel" data-bs-slide="next">
                                                                            <i class="fas fa-caret-square-right fs-5x"></i>
                                                                        </button>
                                                                        <div id="@divTituCarac" data-value="@item.Titulo" style="visibility:hidden">
                                                                        </div>
                                                                        <div id="@divIdCarac" data-value="@item.IdRegistro" style="visibility:hidden"></div>
                                                                    </div>
                                                                </div>

                                        intContadorCaracteristicas++;
                                    }

                                                            <div class="tab-pane fade" id="tab_final" role="tabpanel">
                                                                <div class="rounded w-lg-1000px p-10" style="text-align:center;">
                                                                    <span class="svg-icon svg-icon-10x svg-icon-light text-center"><i class="far fa-thumbs-up fs-5x text-primary"></i></span><br>
                                                                    <h5 class="text-primary text-center fs-3">Finished</h5> <br>
                                                                    <textarea id="Comentario" name="Comentario" class="form-control" rows="4" maxlength="500" data-kt-autosize="true"></textarea>
                                                                    <br />
                                                                    <button id="saveComment" class="btn text-white fs-7 p-3" style="background-color:#44b6ae;" onmouseover="this.style.backgroundColor='#009999';" onmouseout="this.style.backgroundColor='#44b6ae';" data-bs-toggle="modal" data-bs-target="#kt_modal_Employee"
                                                                        onMouseUp="GuardarComentario('@Model.Modelo','@Model.Serie',document.getElementById('Comentario').value);">
                                                                        <i class="far fa-save text-white"></i>Guardar comentario
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div id="javTotal" data-value="@intContadorCaracteristicas" style="visibility:hidden"> </div>
                                }
                            </div>

                            int Intcontador = 1;

                            <ul id="tabs_Features" class="nav nav-tabs nav-line-tabs nav-line-tabs-2x mb-5 fs-6" style="visibility:hidden">
                                @foreach (var item in Model.QualityModelFeatures)
                                {
                                    var strActive = Intcontador != 1 ? "" : "active";

                                    <li class="nav-item">
                                        <a class="nav-link @strActive" href="#tab_@Intcontador" data-bs-toggle="tab"></a>
                                    </li>
                                    Intcontador++;
                                }
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab_final"></a>
                                </li>
                            </ul>
                        }
                        else
                        {
                            @if (Model.Serie != null && Model.Modelo != null)
                            {
                                <div class="alert alert-warning d-flex align-items-center p-5 mb-10">
                                    <span class="svg-icon svg-icon-2x svg-icon-light"> <i class="fas fa-exclamation-triangle fs-2x text-warning"></i></span>&nbsp;&nbsp;&nbsp;&nbsp;
                                    <div class="d-flex flex-column">
                                        <h6 class="text-warning">There are no properties for this search</h6>
                                        <span>Please communicate this to the staff in charge.</span>
                                    </div>
                                </div>
                            }
                        }

                    </div>

                </div>

            </div>
        </div>
    </div>
</div>
@section Scripts {
    @*Loading...*@
    <script>
        var button = document.querySelector("#kt_block_ModelFeatures");
        var target = document.querySelector("#kt_block_ModelFeatures");

        var BlockPantalla = new KTBlockUI(target, {
            message: '<div class="blockui-message"><span class="spinner-border text-primary"></span> Loading...</div>',
        });
    </script>
    
    @*Validation the textbox para comentario *@
    <script>
        $('#Comentario').maxlength({
            threshold: 500,
            warningClass: "badge badge-danger",
            limitReachedClass: "badge badge-success",
            separator: ' of ',
            preText: 'You have ',
            postText: ' chars remaining.',
            validate: true
        });
    </script>

    @if (Model.Serie != null && Model.Modelo != null)
    {
        <script type="text/javascript">
            window.onload = function () {
                document.getElementById('divTitulo').value = $('#divTitulo1').attr('data-value');
                javaTotal = $('#javTotal').attr('data-value');
                javaTotal = javaTotal - 1;
            }
        </script>
    }

@*  Funcion: ValidarModelo
    Method: GetModeloInf, Controller: QualityControl*@
    <script>
        function ValidarModelo() 
        {
            var modelo = $('#Modelo').val();
            var serie = $('#Serie').val();
            var idSeccion = $('#IdSeccion').val();
            if (modelo != "" && Serie != "") 
            {
                $.ajax({
                    url: "@Url.Action("GetModeloInf","QualityControl")",
                    type: "post",
                    data: { modelo: modelo, serie: serie, idSeccion: idSeccion },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN",
                            $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                }).done(function(result) 
                {
                    if(result != null)
                    {
                        if (result == 'Error') {
                            SystemServerError()
                        }
                        else if (result == 'noSession') {
                            swalExpired()
                        }
                        else if (result == 'Sorry') {
                            swalNoAuthorized()
                        }
                        else if (result == 'NoPage') {
                            swalNoAuthorized()
                        }
                        else 
                        {
                            var obj = JSON.parse(result);
                            let status = obj.Respuesta
                            let qty = obj.QTY
                            let comment = obj.Comentario

                            var message = "";

                            if (status == "Aprobado") 
                            {
                                validateChecklist()
                            }
                            else if (status == "Temporal") {
                                message = "<h1>Model Temporary</h1><br><h3>Comment: " + comment + "</h3><br><h3>Quantity to Process: " + qty + "</h3>";
                                Swal.fire({
                                    title: message,
                                    width: '550px',
                                    showCancelButton: false,
                                    buttonsStyling: false,
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    confirmButtonText: "Confirm",
                                    customClass: { confirmButton: "btn btn-primary" }
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        validateChecklist()
                                    }
                                })

                                document.getElementById('btnAccept').style.visibility = 'hidden';
                                document.getElementById('btnReject').style.visibility = 'hidden';
                                document.getElementById('divTitulo').style.visibility = 'hidden';
                                document.getElementById('tabs').style.visibility = 'hidden';
                            }
                            else if (status == "Desaprobado") 
                            {
                                message = "<h1>Model Disapproved</h1><br><h3>Comment: " + comment + "</h3>";

                                Swal.fire({
                                    title: message,
                                    width: '550px',
                                    showCancelButton: false,
                                    buttonsStyling: false,
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    confirmButtonText: "Confirm",
                                    customClass: { confirmButton: "btn btn-primary" }
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        document.getElementById('Modelo').value = '';
                                        document.getElementById('Serie').value = '';
                                        return false;
                                    }
                                })

                                document.getElementById('btnAccept').style.visibility = 'hidden';
                                document.getElementById('btnReject').style.visibility = 'hidden';
                                document.getElementById('divTitulo').style.visibility = 'hidden';
                                document.getElementById('tabs').style.visibility = 'hidden';
                            }
                            else 
                            {
                                toastr.error("The model is not registered!");
                                document.getElementById('Modelo').value = '';
                                document.getElementById('Serie').value = '';

                                document.getElementById('btnAccept').style.visibility = 'hidden';
                                document.getElementById('btnReject').style.visibility = 'hidden';
                                document.getElementById('divTitulo').style.visibility = 'hidden';
                                document.getElementById('tabs').style.visibility = 'hidden';
                                return false;
                            }
                        }
                    }
                    else
                    {
                        SystemServerError()
                    }
                    
                })
                .fail(function(xhr, status, error) 
                {
                        swalErrorServer()
                })
            }
            else 
            {
                if (modelo == "" && Serie == "") 
                {
                    toastr.error("Inputs are Empty!");
                }
                else 
                {
                    toastr.error("The Model is required!");
                }
            }
        }
    </script>

@*  Funcion: ValidaEnsamble
    Method: Assembled, Controller: QualityControl*@
    <script>
        function ValidaEnsamble() {
            var Serie = $("#Serie").val();
            var Modelo = $("#Modelo").val();
            var Station = $("#Station").val();
            var idSeccion = $('#IdSeccion').val();

            $.ajax({
                url: "@Url.Action("Assembled","QualityControl")",
                type: "post",
                data: {
                    Opcion: 1,
                    Serie: Serie,
                    Modelo: Modelo,
                    idSeccion: idSeccion,
                    Station: Station
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                },
            })
                .done(function(result)
                {
                    if(result != null)
                    {
                        if (result == 'Error') {
                            SystemServerError()
                        }
                        else if (result == 'noSession') {
                            swalExpired()
                        }
                        else if (result == 'Sorry') {
                            swalNoAuthorized()
                        }
                        else if (result == 'NoPage') {
                            swalNoAuthorized()
                        }
                        else if (result == 'Continua') {
                            document.getElementById('frmBusqueda').submit();
                        }
                        else {
                            var obj = JSON.parse(result);

                            let ID_Registro = obj.ID_Registro;
                            let ID_Request = obj.ID_Request;
                            let Codigo = obj.Codigo;
                            let DCodigo = obj.DCodigo;

                            var comentarios_garantias = `<span style="font-size:35px;" class="text-danger"> Este Motor debe contar con el componente:</span></br></br> <span style="font-size:60px;" class="text-danger">Code: ${Codigo} </br> ${DCodigo} </span></br> <span style="font-size:60px;" class="text-danger">ANP: REQ-${ID_Request} </span></br><input type="hidden" name="RegitroEnsamble" id="RegitroEnsamble"  value="${ID_Registro}"/>`

                            Swal.fire({
                                title: comentarios_garantias,
                                width: '1300px',
                                showCancelButton: false,
                                buttonsStyling: false,
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                confirmButtonText: "Me doy por Enterado.",
                                customClass: { confirmButton: "btn btn-primary" }
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    BlockPantalla.block();
                                    document.getElementById('frmBusqueda').submit();
                                }
                            })
                        }
                    }else
                    {
                        SystemServerError()
                    }
                    
                })
                .fail(function(xhr, status, error) {
                    swalErrorServer()
                })
        }
    </script>

 @*Validacion para el carrucel*@
    <script type="text/javascript">
        var javaContador = 1;
        var javaTotal = 1;

        function Execute(opcion) 
        {
            try {
                if (javaContador != javaTotal) 
                {
                    var featureId = $('#divID' + javaContador).attr('data-value');
                    Guardar(opcion, featureId);

                    document.getElementById('divTitulo').value = $('#divTitulo' + (javaContador + 1)).attr('data-value');
                    $('[href="#tab_' + (javaContador + 1) + '"]').tab('show');
                }
                else 
                {
                    nonExistentFunction();
                }
            }
            catch (err) 
            {
                document.getElementById('btnAccept').style.visibility = 'hidden';
                document.getElementById('btnReject').style.visibility = 'hidden';
                document.getElementById('divTitulo').style.display = 'none';
                $('[href="#tab_final"]').tab('show');
            };

            javaContador++;
        }
    </script>

@*  Funcion: Guardar
    Method: SaveFeature, Controller: QualityControl*@
    <script>
          function Guardar(opcion, featureId) 
          {
            modelo = $("#modeloFinal").val();
            serie = $("#serieFinal").val();
            estacion = $("#Station").val();
            var idSeccion = $('#IdSeccion').val();

            document.getElementById('Search').disabled = true;
            document.getElementById('btnAccept').disabled = true;
            document.getElementById('btnReject').disabled = true;

            BlockPantalla.block();

            $.ajax({
                url: "@Url.Action("SaveFeature","QualityControl")",
                data: {
                    featureId: featureId,
                    serie: serie,
                    modelo: modelo,
                    opcion: opcion,
                    idSeccion: idSeccion,
                    estacion: estacion
                },
                type: 'POST',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                },
            }).done(function(result) 
            {

                if(result != null)
                {
                    if (result == 'Error') 
                    {
                        SystemServerError()
                    }
                    else if (result == 'noSession') {
                        swalExpired()
                    }
                    else if (result == 'Sorry') {
                        swalNoAuthorized()
                    }
                    else if (result == 'NoPage') {
                        swalNoAuthorized()
                    }
                    else if (result == 'correcto') {
                        BlockPantalla.release();
                        setTimeout(function () {
                            document.getElementById('Search').disabled = false;
                            document.getElementById('btnAccept').disabled = false;
                            document.getElementById('btnReject').disabled = false;
                        }, 1000);
                    }
                }
                else {
                    SystemServerError()
                }
            }).fail(function(error) {
                swalErrorServer()
            });
        }
    </script>

@*  Funcion: validateChecklist
    Method: ValidateMissingAssamble, Controller: QualityControl*@
    <script type="text/javascript">
        function validateChecklist() {
            var modelo = $('#Modelo').val();
            var serie = $("#Serie").val();
            var estacion = $("#Station").val();
            var idSeccion = $('#IdSeccion').val();
            var SerieCheck = serie.replace(/[^a-zA-Z 0-9.]+/g, '');
            serie = SerieCheck.replace(/(\r\n|\n|\r)/gm, "");
            if (estacion != '' && estacion != 10) {
                BlockPantalla.block()

                $.ajax({
                    url: "@Url.Action("ValidateMissingAssamble","QualityControl")",
                    data: {
                        serie: serie,
                        modelo: modelo,
                        estacion: estacion,
                        idSeccion: idSeccion
                    },
                    type: "POST",
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN",
                            $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                })
                    .done(function(result) {
                        if (result != null) {
                            if (result == 'Error') {
                                SystemServerError()
                            }
                            else if (result == 'noSession') {
                                swalExpired()
                            }
                            else if (result == 'Sorry') {
                                swalNoAuthorized()
                            }
                            else if (result == 'NoPage') {
                                swalNoAuthorized()
                            }
                            else 
                            {
                                var obj = JSON.parse(result);

                                let resultado = obj.Respuesta;
                                let ensamble1 = obj.Ensamble1;
                                let ensamble2 = obj.Ensamble2;
                                let ensamble3 = obj.Ensamble3;
                                let ensamble4 = obj.Ensamble4;
                                let ensamble5 = obj.Ensamble5;
                                let ensamble6 = obj.Ensamble6;
                                let lavado = obj.Lavado;
                                let caracteristica = obj.Caracteristica;
                            
                                if (caracteristica > 0) 
                                {
                                    if (resultado == 'Correcto') 
                                    {
                                        ValidaEnsamble()
                                    }
                                    else if (resultado == 'Valida') 
                                    {
                                        var joined = '';

                                        if (ensamble1 == 1) 
                                        {
                                            ensamble1 = '<h3><i class="far fa-edit text-danger fs-2x" ></i> Check List Ensamble 1 Pending</h3><br>';
                                            var joined = joined.concat(ensamble1);
                                        } else 
                                        {
                                            ensamble1 = '';
                                        }
                                        if (ensamble2 == 1) 
                                        {
                                            ensamble2 = '<h3><i class="far fa-edit text-danger fs-2x"></i> Check List Ensamble 2 Pending</h3><br>';
                                            var joined = joined.concat(ensamble2);
                                        } else {
                                            ensamble2 = '';
                                        }
                                        if (ensamble3 == 1) 
                                        {
                                            ensamble3 = '<h3><i class="far fa-edit text-danger fs-2x"></i> Check List Ensamble 3 Pending</h3><br>';
                                            var joined = joined.concat(ensamble3);
                                        } else {
                                            ensamble3 = '';
                                        }
                                        if (ensamble4 == 1) {
                                            ensamble4 = '<h3><i class="far fa-edit text-danger fs-2x"></i> Check List Ensamble 4 Pending</h3><br>';
                                            var joined = joined.concat(ensamble4);
                                        } else {
                                            ensamble4 = '';
                                        }
                                        if (ensamble5 == 1) {
                                            ensamble5 = '<h3><i class="far fa-edit text-danger fs-2x"></i> Check List Ensamble 5 Pending</h3><br>';
                                            var joined = joined.concat(ensamble5);
                                        } else {
                                            ensamble5 = '';
                                        }
                                        if (ensamble6 == 1) 
                                        {
                                            ensamble6 = '<h3><i class="far fa-edit text-danger fs-2x"></i> Check List Ensamble 6 Pending</h3><br>';
                                            var joined = joined.concat(ensamble6);
                                        } else {
                                            ensamble6 = '';
                                        }
                                        if (lavado == 1) 
                                        {
                                            lavado = '<h3><i class="far fa-edit  text-danger fs-2x"></i> Check List Lavado Block y Cig. Pending</h3><br>'
                                            var joined = joined.concat(lavado);
                                        } else {
                                            lavado = '';
                                        }
                                        BlockPantalla.release();

                                        Swal.fire({
                                            title: "<h1>Check List Pending</h1><br>" + joined,
                                            width: '550px',
                                            showCancelButton: false,
                                            buttonsStyling: false,
                                            allowOutsideClick: false,
                                            allowEscapeKey: false,
                                            confirmButtonText: "Closed",
                                            customClass: {
                                                confirmButton: "btn btn-primary"
                                            }
                                        }).then((result) => {
                                            if (result.isConfirmed) 
                                            {
                                                $('#Modelo').val("");
                                                $('#Serie').val("");
                                                BlockPantalla.release();
                                            }
                                        })
                                    }
                                    else 
                                    {
                                        BlockPantalla.release();
                                        $('#Modelo').val("");
                                        $('#Serie').val("");
                                        toastr.error("An error occurred on the server, please try again later!");
                                    }
                                } else 
                                {
                                    document.getElementById('frmBusqueda').submit();
                                    BlockPantalla.release();
                                }
                            }
                        }
                    })
                    .fail(function(error) 
                    {
                        swalErrorServer()
                    });
            }
            else 
            {
                if (estacion != '') 
                {
                    ValidaEnsamble()
                } else {
                    toastr.error("An error occurred on the server, please try again later!");
                    BlockPantalla.release();
                }
            }
        }
    </script>

@*  Funcion: GuardarComentario
    Method: SaveComment, Controller: QualityControl*@
    <script type="text/javascript">
        function GuardarComentario(modelo, motor, comentario) {
            var idSeccion = $('#IdSeccion').val();
            if (comentario != '') {
                BlockPantalla.block();
                var Station = $("#Station").val();
                $.ajax({
                    url: "@Url.Action("SaveComment","QualityControl")",
                    data: {
                        motor: motor,
                        modelo: modelo,
                        comentario: comentario,
                        Station: Station,
                        idSeccion: idSeccion
                    },
                    type: 'POST',
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN",
                            $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                })
                    .done(function(result) {
                        if(result != null)
                        {
                            if (result == 'Error') {
                                SystemServerError()
                            }
                            else if (result == 'noSession') {
                                swalExpired()
                            }
                            else if (result == 'Sorry') {
                                swalNoAuthorized()
                            }
                            else if (result == 'NoPage') {
                                swalNoAuthorized()
                            }
                            else if (result == 'correcto') {
                                BlockPantalla.release();

                                document.getElementById('Comentario').value = "";
                                document.getElementById('Comentario').disabled = true;
                                document.getElementById('saveComment').disabled = true;

                                toastr.success("Comment saved successfully!");
                                $("#Modelo").val("");
                                $("#Serie").val("");
                                $("#tab_final").css("display", "none");
                            }
                        }
                        else 
                        {
                            SystemServerError()
                            BlockPantalla.release();
                        }
                    }).fail(function(xhr, status, error) {
                        swalErrorServer()
                    })
            }
            else 
            {
                toastr.warning("The comment is required!");
                ("#Comentario").focus();
                BlockPantalla.release();
            }
        }
    </script>
}